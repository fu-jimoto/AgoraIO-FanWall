<!DOCTYPE html>
<html>
<head>
<title>FanWall-Host</title>
<script src="AgoraRTC_N-4.7.1.js"></script>
<script src="vendor/jquery.js"></script>
<link rel="stylesheet" href="index.css">
</head>

<body>
<div id="div_device" class="">
<div class="select">
<label for="audioSource">Audio source: </label><select id="audioSource"></select>
</div>
<div class="select">
<label for="videoSource">Video source: </label><select id="videoSource"></select>
</div>
</div>

<div id="div_join" class="">
<div class="">
App ID: <input id="appId" type="text" value="" size="36"></input>
Channel: <input id="channel" type="text" value="main" size="4"></input>
<button id="join" class="" onclick="join()">Join</button>
</div>
</div>

<div id="video" style="margin:0 auto;">
    <div id="agora_local" style="float:right;width:210px;height:147px;display:inline-block;"></div>
</div>

<script language="javascript">

if(!AgoraRTC.checkSystemRequirements()) {
  alert("Your browser does not support WebRTC!");
}

var client = AgoraRTC.createClient({mode: 'live', codec:'vp8'});
var audioSelect = document.querySelector('select#audioSource');
var videoSelect = document.querySelector('select#videoSource');
var remoteUsers = {};
var localTracks = {
  videoTrack: null,
  audioTrack: null
};

async function join() {

  client.on("user-published", handleUserPublished);
  client.on("user-unpublished", handleUserUnpublished);

  [ uid, localTracks.audioTrack, localTracks.videoTrack ] = await Promise.all([
    client.join(appId.value, channel.value, null,1000),
    AgoraRTC.createMicrophoneAudioTrack({microphoneId:audioSource.value}),
    AgoraRTC.createCameraVideoTrack({cameraId:videoSource.value})
  ]);
  localTracks.videoTrack.play("agora_local");
  await client.setClientRole("host");
  await client.publish(Object.values(localTracks));
  console.log("publish success");
}

async function subscribe(user, mediaType) {
  const uid = user.uid;
  // subscribe to a remote user
  await client.subscribe(user, mediaType);
  console.log("subscribe success");
  if (mediaType === 'video') {
    const player = $(`
      <div id="player-wrapper-${uid}">
        <div id="player-${uid}" class="player"></div>
      </div>
    `);
    $("#video").append(player);
    user.videoTrack.play(`player-${uid}`);
  }
  if (mediaType === 'audio') {
    user.audioTrack.play();
  }
}

function handleUserPublished(user, mediaType) {
  console.log("handleUserPublished");
  const id = user.uid;
  remoteUsers[id] = user;
  subscribe(user, mediaType);
}

function handleUserUnpublished(user) {
  const id = user.uid;
  delete remoteUsers[id];
  $(`#player-wrapper-${id}`).remove();
}

function getDevices() {
  AgoraRTC.getDevices().then(devices => {
    for (var i = 0; i !== devices.length; ++i) {
      var device = devices[i];
      var option = document.createElement('option');
      option.value = device.deviceId;
      if (device.kind === 'audioinput') {
        option.text = device.label || 'microphone ' + (audioSelect.length + 1);
        audioSelect.appendChild(option);
      } else if (device.kind === 'videoinput') {
        option.text = device.label || 'camera ' + (videoSelect.length + 1);
        videoSelect.appendChild(option);
      } else {
        console.log('Some other kind of source/device: ', device);
      }
    }
  }).catch(e => {
    console.log("get devices error!", e);
  });
}
getDevices();
</script>
</body>
</html>
