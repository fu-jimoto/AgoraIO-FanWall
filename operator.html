<!DOCTYPE html>
<html>
<head>
<title>FanWall-Operator</title>
<script src="AgoraRTC_N-4.7.1.js"></script>
<script src="agora-rtm-sdk-1.4.3.js"></script>
<script src="vendor/jquery.js"></script>
<link rel="stylesheet" href="index.css">
</head>

<body>

<div id="div_join" class="">
<div class="">
App ID: <input id="appId" type="text" value="" size="36"></input>
<button id="join" class="" onclick="join()">Join</button>
</div>
</div>

<div id="video" style="margin:0 auto;">
</div>

<script language="javascript">

if(!AgoraRTC.checkSystemRequirements()) {
  alert("Your browser does not support WebRTC!");
}

var client  = AgoraRTC.createClient({mode: 'live', codec:'vp8'});
var userChannel = liveId = getParam('c');
var remoteUsers = {};

//rtm
var rtm, rtmChannel;

//user info
var userInfo = [];

async function join() {
  client.on("user-published", handleUserPublished);
  client.on("user-unpublished", handleUserUnpublished);

  //ライブ配信視聴用
  [ uid ] = await Promise.all([
    client.join(appId.value, userChannel, null),
  ]);

  //rtm
  rtm = AgoraRTM.createInstance(appId.value);
  rtm.login({ token: '', uid: userChannel+uid }).then(() => {
    console.log('AgoraRTM client login success');

    //rtm channel
    rtmChannel = rtm.createChannel(userChannel);
    rtmChannel.join().then(()=>{
      console.log("RTM Join Channel Success");
      rtmChannel.on('ChannelMessage', function (message, memberId) {
        console.log("Get channel message:"+memberId);
        console.dir(message);
        var info = JSON.parse(message.text);
        userInfo[info.uid] = info.nickname;
      });
      //名前の要求（先人入室しているユーザー用）
      rtmChannel.sendMessage({text: "requestInfo"});
    });
  }).catch(err => {
    console.log('AgoraRTM client login failure', err);
  });
}



async function subscribe(user, mediaType) {
  const uid = user.uid;
  // subscribe to a remote user
  await client.subscribe(user, mediaType);
  console.log("subscribe success");
  if (mediaType === 'video') {
    const player = $(`
      <div id="player-wrapper-${uid}">
        <div id="userinfo-${uid}"></div>
        <div id="player-${uid}" class="player"></div>
      </div>
    `);
    $("#video").append(player);
    user.videoTrack.play(`player-${uid}`);
  }
  if (mediaType === 'audio') {
    user.audioTrack.play();
  }
}

function handleUserPublished(user, mediaType) {
  console.log("handleUserPublished");
  const id = user.uid;
  remoteUsers[id] = user;
  subscribe(user, mediaType);
}

function handleUserUnpublished(user) {
  const id = user.uid;
  delete remoteUsers[id];
  $(`#player-wrapper-${id}`).remove();
}

function getParam(name, url) {
  if (!url) url = window.location.href;
  name = name.replace(/[\[\]]/g, "\\$&");
  var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
    results = regex.exec(url);
  if (!results) return null;
  if (!results[2]) return '';
  return decodeURIComponent(results[2].replace(/\+/g, " "));
}

function invite(uid){
  var peerId = userChannel+uid;
  rtm.sendMessageToPeer({ text: $("#invite_"+uid).val() }, peerId,).then(sendResult => {
  }).catch(error => {
  });
}

var updateUserInfo = function(){
  for(var uid in userInfo){
    if ($('#userinfo-'+uid).length > 0) {
      $('#userinfo-'+uid).html('ニックネーム:'+userInfo[uid]+' <input type="text" id="invite_'+uid+'" /><button onClick="invite('+uid+');">チャンネル移動</button>');
    }
  }
}
setInterval(updateUserInfo, 10*1000);


</script>
</body>
</html>
