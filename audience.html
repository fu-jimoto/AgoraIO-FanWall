<!DOCTYPE html>
<html>
<head>
<title>FanWall-Audience</title>
<script src="AgoraRTC_N-4.7.1.js"></script>
<script src="agora-rtm-sdk-1.4.3.js"></script>
<script src="vendor/jquery.js"></script>
<link rel="stylesheet" href="index.css">
</head>

<body>
<div id="div_device" class="">
<div class="select">
<label for="audioSource">Audio source: </label><select id="audioSource"></select>
</div>
<div class="select">
<label for="videoSource">Video source: </label><select id="videoSource"></select>
</div>
</div>

<div id="div_join" class="">
<div class="">
App ID: <input id="appId" type="text" value="" size="36"></input>
Channel: <input id="channel" type="text" value="main" size="4"></input>
ニックネーム: <input id="nickname" type="text" value="" size="10"></input>
<button id="join" class="" onclick="join()">Join</button>
</div>
</div>

<div id="video" style="margin:0 auto;">
    <div id="agora_local" style="float:right;width:210px;height:147px;display:inline-block;"></div>
</div>

<script language="javascript">

if(!AgoraRTC.checkSystemRequirements()) {
  alert("Your browser does not support WebRTC!");
}

//video
var client  = AgoraRTC.createClient({mode: 'live', codec:'vp8'});
var client2 = AgoraRTC.createClient({mode: 'live', codec:'vp8'});
var audioSelect = document.querySelector('select#audioSource');
var videoSelect = document.querySelector('select#videoSource');
var remoteUsers = {};
var localTracks = {
  videoTrack: null,
  audioTrack: null
};
var currentChannel;
//rtm
var rtm, rtmChannel;


async function join() {
  client.on("user-published", handleUserPublished);
  client.on("user-unpublished", handleUserUnpublished);

  //ライブ配信視聴用
  [ uid ] = await Promise.all([
    client.join(appId.value, channel.value, null),
  ]);

  //会場モニター用
  var userChannel =  getChannelName();
  currentChannel = userChannel;
  [ uid2, localTracks.videoTrack ] = await Promise.all([
    client2.join(appId.value,userChannel, null),
    AgoraRTC.createCameraVideoTrack({cameraId:videoSource.value})
  ]);
  localTracks.videoTrack.play("agora_local");
  await client2.setClientRole("host");
  await client2.publish(localTracks.videoTrack);
  console.log("publish success");

  //rtm
  rtm = AgoraRTM.createInstance(appId.value);
  rtm.login({ token: '', uid: userChannel+uid2 }).then(() => {
      console.log('AgoraRTM client login success');

      rtm.on('MessageFromPeer', async function (message, peerId) {
          console.dir(message.text);
          //localTracを一旦破棄
          for (trackName in localTracks) {
            var track = localTracks[trackName];
            if(track) {
              track.stop();
              track.close();
              localTracks[trackName] = undefined;
            }
          }
          //既存のチャンネルからは離脱
          if(currentChannel != "main"){
            await client2.leave();
          }

          if(message.text == "main"){//メインチャンネルへ配信
              [ localTracks.audioTrack, localTracks.videoTrack ] = await Promise.all([
                AgoraRTC.createMicrophoneAudioTrack({microphoneId:audioSource.value}),
                AgoraRTC.createCameraVideoTrack({cameraId:videoSource.value})
              ]);

              localTracks.videoTrack.play("agora_local");
              await client.setClientRole("host");
              await client.publish(Object.values(localTracks));
              currentChannel = "main";

          }else{//他のチャンネルへ移動
            await client.setClientRole("audience");
            [ uid2, localTracks.videoTrack ] = await Promise.all([
              client2.join(appId.value,message.text, null, uid2),
              AgoraRTC.createCameraVideoTrack({cameraId:videoSource.value})
            ]);
            localTracks.videoTrack.play("agora_local");
            await client2.publish(localTracks.videoTrack);
            currentChannel = message.text;
          }
      });

      //rtm channel
      rtmChannel = rtm.createChannel(userChannel);
      rtmChannel.join().then(()=>{
          console.log("RTM Join Channel Success");
          sendUserInfo(uid2);

          rtmChannel.on('ChannelMessage', function (message, memberId) {
              console.log("Get channel message:"+memberId);
              console.dir(message);
              if(message.text == "requestInfo"){
                  sendUserInfo(uid2);
              }
          });

      });
  }).catch(err => {
      console.log('AgoraRTM client login failure', err);
  });
}

function leave() {
}

function getDevices() {
    AgoraRTC.getDevices().then(devices => {
    for (var i = 0; i !== devices.length; ++i) {
      var device = devices[i];
      var option = document.createElement('option');
      option.value = device.deviceId;
      if (device.kind === 'audioinput') {
        option.text = device.label || 'microphone ' + (audioSelect.length + 1);
        audioSelect.appendChild(option);
      } else if (device.kind === 'videoinput') {
        option.text = device.label || 'camera ' + (videoSelect.length + 1);
        videoSelect.appendChild(option);
      } else {
        console.log('Some other kind of source/device: ', device);
      }
    }
  }).catch(e => {
    console.log("get devices error!", e);
  });
}

async function subscribe(user, mediaType) {
  const uid = user.uid;
  // subscribe to a remote user
  await client.subscribe(user, mediaType);
  console.log("subscribe success");
  if (mediaType === 'video') {
    const player = $(`
      <div id="player-wrapper-${uid}">
        <div id="player-${uid}" class="player"></div>
      </div>
    `);
    $("#video").append(player);
    user.videoTrack.play(`player-${uid}`);
  }
  if (mediaType === 'audio') {
    user.audioTrack.play();
  }
}

function handleUserPublished(user, mediaType) {
  console.log("handleUserPublished");
  const id = user.uid;
  remoteUsers[id] = user;
  subscribe(user, mediaType);
}

function handleUserUnpublished(user) {
  const id = user.uid;
  delete remoteUsers[id];
  $(`#player-wrapper-${id}`).remove();
}

function getChannelName(){
    //本来はサーバー側で管理して、APIで取得する
    //サーバ側では各チャネルの人数を保持して16人を超えないようにする
    //var channels = ["B1","B2","B3"];
    var channels = ["B1"];
    return channels[Math.floor(Math.random() * channels.length)];
}

function sendUserInfo(uid){
    //send information
    var info = JSON.stringify({nickname: nickname.value, uid: uid});
    rtmChannel.sendMessage({text: info});
}


getDevices();
</script>
</body>
</html>
